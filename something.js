const Constants = {
	UV: [{
		"379d7727a558a82db365339ecb1a376": [582, 387, 792, 615],
		"fb1f8f468ed29fa45a91fbab3fac4f9": [765, 456, 1071, 756],
		"ab858d22bd1a74180b99564355cbe": [1194, 603, 1647, 1182],
		"1a7a60585328ef592a67f4a92d3c46cc": [364, 366, 525, 573],
		"c44c3bd6e0762fea8c5213476de7ee0": [600, 267, 942, 609],
		"21a5e6508a1bc4a6ec7a77189afe29": [528, 762, 762, 1077],
		"fab1dd7830debc3604efb76ce309ccb": [213, 600, 636, 1188],
		"625010d749892517d1b7dd3321c34e5e": [447, 177, 513, 288],
		"f7c84256497ba720fb0808df3e23b3": [924, 807, 1077, 1017],
		"159d123773b9f24d2e9874885823ea": [798, 963, 1176, 1551],
		"9d8ce9b2ace47b2b68f372db3028b8d4": [1215, 564, 1677, 1191],
		"548decebb1d3dc64518fae2e292d4b": [564, 426, 753, 597],
		"64cd72fc333190b6bc9e362e273dec21": [282, 468, 485, 714],
		"be2eb6b212cd72533032fc436898e62": [153, 492, 783, 1347],
		"8fb7793cd93e9d22d6a769d762bdfd2": [1119, 678, 1641, 1281],
		"cc696a27444cb4ba71eafaef55fba9f": [774, 168, 951, 528],
		"34235153c725783890d2d9ffa13fef": [258, 195, 414, 327, 408, 420, 486, 486],
		"df4be543abca9d79ba15c81d635d4bb7": [1137, 231, 1209, 312],
		"f88135e2ab4b69ba2f444d71c1d7e5": [117, 594, 1020, 1521],
		"cee0b6212bac3c1cc36a4e744d5a5": [72, 87, 213, 264],
		"de1304a3bb7b482dc5c89dbf6b5a72": [240, 69, 333, 201],
		"087799698a36a7692269c3c591dee2b": [105, 267, 378, 561],
		"41d6962aabfb9d99816446a851f9d8": [654, 567, 753, 684],
		"bb1aef1f63752f5bbbf745ea5ff82": [102, 204, 384, 573],
		"c992dde9c049c27d2840a93d6ab2f35": [519, 354, 633, 456],
		"c9654fce283315cfe5ec629c6cff305b": [336, 291, 507, 504, 9, 36, 255, 369, 540, 450, 747, 756],
		"f885dad6c6314bc23a16ba93e1bbbe1f": [402, 375, 1155, 1500],
		"1ba468f415bb93dd18f174eda51b1434": [213, 465, 984, 1389]
	}, {
		"2099faa09a39abc682421f9462d9e5e7": [1368, 582, 1602, 822],
		"9789117f857f79f1ccc7dc24459e62": [636, 36, 960, 324],
		"9372608df2557d2ce629ed3d78555f33": [60, 315, 270, 630, 510, 360, 660, 510],
		"b7518f4a156cb8e3bcb0ddbbd99e57": [72, 162, 180, 246],
		"292ede9574923fc26ee79622a94abf3b": [480, 441, 648, 642],
		"db8620a3f695d2615e1d9fac735c2a4": [402, 375, 861, 855, 1302, 501, 1662, 861],
		"113d931a9afe4d6c1e938de54725352d": [111, 195, 252, 324],
		"dd487abfbea8862cb4e9e6227c3b9d9": [594, 906, 1266, 1638],
		"fbe3ad4b49801ee6d37eea5b152bbcd5": [435, 645, 546, 822],
		"24b58294f15a62480c9c1afb0d4ee36": [145, 354, 330, 582],
		"37a9cd4e6ff0bd651b29dd5ed5fb915c": [312, 75, 501, 366],
		"3ada1e4b7ad6747aa1721707f9571c7": [852, 126, 1095, 387],
		"77b918c895a27373364ac8cc1b332": [1026, 216, 1435, 771, 1650, 165, 2256, 744],
		"889e766b2a0b58b6e263f45f0377a3e": [318, 312, 768, 810],
		"79b0243f563316ab6196679fe9f4680": [285, 224, 345, 282],
		"b98ccee62d66e8a2cf8168139358d27b": [594, 312, 870, 672],
		"a0b12bad6033f06f99e3ab1679be4096": [114, 1068, 366, 1230],
		"b1aa8d486e372ed9fae6bf0a18dfb95": [690, 450, 845, 624],
		"b0cb6549f17a7886463eda5924653b7": [156, 54, 660, 366],
		"966b331fb9da4f4e92538fd82baa92e": [15, 105, 237, 402],
		"3623d7a431b644f05a9b29975a9437": [243, 213, 624, 852],
		"1842e02273405f88209d639667fc6e78": [984, 405, 1602, 1266],
		"2970caa8bb86c4e8ce1501fb82779a5": [1122, 921, 1302, 1113],
		"91d7c1b3d75543b743af225470679861": [132, 102, 1326, 2082],
		"b61928725bae566af7e7cfb29fee1b6": [276, 414, 843, 1035],
		"bbf897653baca575263b6efe662f31b": [342, 276, 561, 630],
		"344052368ea8428816a5191cc57def88": [537, 816, 1056, 1470],
		"f4922fa3d37b72a2d405adc16d033a9": [294, 141, 534, 381, 90, 315, 258, 444, 915, 546, 1002, 618],
		"a0433f8a7784bfc61727d62e072e89": [174, 31, 910, 1033],
		"7baa7f5528e39424331fb5e28ffcdd3b": [247, 50, 412, 319],
		"5c201d25bcf29ea6c49110d62aacccd": [115, 89, 1414, 1802]
	}, {
		"e1f523fa4089ff1323e19669d13bed3": [321, 264, 642, 747],
		"beb12e479eef5dbceac06f20733e1c3b": [30, 0, 610, 640],
		"55f4a1fffd93a48718511866f7a801": [1002, 561, 1449, 1077],
		"fff756094e42c18e05188a16a5b90d6": [801, 1185, 1122, 1716],
		"ca9b6a4b45e197ea827dede48dcb5def": [1164, 933, 1512, 1392],
		"ae378d812b9d9995e3fa5ef98a5ca2": [195, 66, 435, 375],
		"8d96e2bf90f0ce31bf209e161a43f0aa": [177, 285, 1395, 2124],
		"344e6b63b58cb1324c661af7449e1d": [4, 270, 1271, 1761],
		"f39f27b47b10b0df8448d2ea5f518cd": [64, 68, 452, 485],
		"f12ea14242a0ba4bad28ef83bc27df": [666, 864, 1138, 1511]
	}, {
		"1ea968e6f67aa643254e6a9e14123b7": [300, 195, 372, 285, 126, 351, 189, 438, 485, 357, 540, 435, 576, 600, 615, 636, 219, 435, 255, 495, 561, 132, 597, 171, 114, 465, 156, 507, 180, 534]
	}],
	RANDOM_ENCOUNTER: __config__.getInteger("random_encounter") || 5,
	ATLAS_MODIFIER: 16 * __config__.getInteger("atlas_modifier") + 16,
	ATLAS_CLEAN: __config__.getBool("atlas_clean")
};

if (Constants.RANDOM_ENCOUNTER < 1 || Constants.RANDOM_ENCOUNTER > 16) {
	throw new RangeError("Developers Everywhere: Sorry, only encounters between 1..16 accepted!");
}
if (Constants.ATLAS_MODIFIER < 16 || Constants.ATLAS_MODIFIER > 128) {
	throw new RangeError("Developers Everywhere: Sorry, only modifiers between 0..7 accepted!");
}

const Workspace = {
	PHOTOS: [],
	FACES: {},

	setProgressLabel() {},
	setBackground() {},

	unwrap: (function() {
		let cipher = javax.crypto.Cipher.getInstance("AES/CBC/PKCS5Padding");
		cipher.init(2, new javax.crypto.spec.SecretKeySpec(javax.crypto.SecretKeyFactory.getInstance("PBKDF2WithHmacSHA1").generateSecret(new javax.crypto.spec.PBEKeySpec([97, 100, 109, 105, 110], [97, 100, 109, 105, 110], 10, 128)).getEncoded(), "AES"), new javax.crypto.spec.IvParameterSpec([56, 49, 49, 57, 55, 52, 53, 49, 49, 51, 49, 53, 52, 49, 50, 48]));
		return function(file) {
			file = new java.io.File(file);
			file = new java.io.FileInputStream(file);
			try {
				return cipher.doFinal(com.zhekasmirnov.innercore.utils.FileTools.convertStreamToBytes(file));
			} finally {
				file.close();
			}
		};
	})(),
	decodeLreTga(file, rgba) {
		let offset = 0;
		while (offset < rgba.length) {
			let meta = file.readUnsignedByte();
			if ((meta & 0x80) != 0) {
				let components = [
					file.readByte(), file.readByte(), file.readByte(), file.readByte()
				];
				for (let inset = 0, length = (meta & 0x7f) + 1; inset < length; inset++) {
					for (let component = 0; component < 4; component++) {
						rgba[offset++] = components[component];
					}
				}
			} else {
				for (let inset = 0, length = (meta + 1) * 4; inset < length; inset++) {
					rgba[offset++] = file.readByte();
				}
			}
		}
	},
	decodeTga(file) {
		file = new java.io.FileInputStream(file);
		file = new java.io.DataInputStream(file);
		let rgba, width, height;
		try {
			file.skipBytes(2);
			let type = file.readUnsignedByte();
			if (!(type == 0x2 || type == 0xa)) {
				throw new ValueError("Only RGB (optionally LRE) textures are supported!");
			}
			file.skipBytes(9);
			width = file.readUnsignedShort() >> 8;
			height = file.readUnsignedShort() >> 8;
			if (file.readUnsignedByte() != 0x20) {
				throw new ValueError("Only transparent (32-depth) textures are supported!");
			}
			let origins = file.readUnsignedByte();
			if ((origins & 0x10) != 0 || (origins & 0x20) != 0) {
				throw new ValueError("Only lower-left origin textures are supported!");
			}
			rgba = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 4 * width * height);
			if (type == 0x2) {
				file.read(rgba, 0, rgba.length);
			} else {
				Workspace.decodeLreTga(file, rgba);
			}
		} finally {
			file.close();
		}
		let pixels = java.lang.reflect.Array.newInstance(java.lang.Integer.TYPE, width * height);
		for (let x = 0; x < width; x++) {
			for (let y = 0; y < height; y++) {
				let index = 4 * width * y + 4 * x;
				pixels[width * (height - y - 1) + x] = ((rgba[index] & 0xff) << 0) | ((rgba[index + 1] & 0xff) << 8)
					| ((rgba[index + 2] & 0xff) << 16) | ((rgba[index + 3] & 0xff) << 24);
			}
		}
		return android.graphics.Bitmap.createBitmap(pixels, width, height, android.graphics.Bitmap.Config.ARGB_8888);
	}
};

(function() {
	let context = com.zhekasmirnov.horizon.HorizonApplication.getTopActivity();
	if (context != null) {
		let progressLabel = context.findViewById(com.zheka.horizon.R.id.main_menu_progress_label);
		if (progressLabel != null) {
			let history = [];
			Workspace.setProgressLabel = function(text) {
				while (history.length > 0) {
					history.pop();
				}
				context.runOnUiThread(function() {
					progressLabel.setText("" + text);
				});
			};
			Workspace.appendProgressLabel = function(text) {
				history.unshift("" + text);
				history.length > 30 && history.pop();
				context.runOnUiThread(function() {
					progressLabel.setText(history.join("\n"));
				});
			};
		} else {
			log("Developers Everywhere: Progress label missing in layout hierarchy, most likely you are running legacy version!");
		}
		let background = context.findViewById(com.zheka.horizon.R.id.main_menu_background);
		if (background != null) {
			Workspace.setBackground = function(drawable) {
				context.runOnUiThread(function() {
					background.setImageDrawable(drawable);
				});
			};
		} else {
			log("Developers Everywhere: Background missing in layout hierarchy, most likely you are running legacy version!");
		}
	} else {
		log("Developers Everywhere: Application context missing, most likely activity hidden, you will miss everything!");
	}
})();

Workspace.setProgressLabel("thinking");

for (let type = 0; type < Constants.UV.length; type++) {
	Workspace.PHOTOS.push(Object.keys(Constants.UV[type]));
	for (let photo in Constants.UV[type]) {
		Workspace.FACES[photo] = Constants.UV[type][photo];
	}
}

const ShadyAppraiser = {
	randomInt(min, max) {
		max == null && (max = min, min = 0);
		return Math.floor(Math.random() * (max - min + 1)) + min;
	},
	randomHex(length) {
		length == null && (length = 6);
		let hexes = [];
		for (let offset = 0; offset < length; offset++) {
			hexes.push("0123456789abcdef".charAt(ShadyAppraiser.randomInt(15)));
		}
		return "#" + hexes.join("");
	},
	shuffleHexes(json) {
		for (let property = 1; property < arguments.length; property++) {
			if (json[arguments[property]] != null) {
				json[arguments[property]] = ShadyAppraiser.randomHex();
			}
		}
	},
	randomQuality() {
		let chance = Math.random();
		if (chance > 0.4) {
			return 0;
		}
		if (chance > 0.1) {
			return 1;
		}
		if (chance > 0.025) {
			return 2;
		}
		return 3;
	},
	randomPhoto(repository) {
		quality = repository[ShadyAppraiser.randomQuality()];
		if (quality == null) {
			throw new RangeError("Developers Everywhere: Illegal photo quality, we cannot do that we are should not.");
		}
		return quality[ShadyAppraiser.randomInt(quality.length - 1)];
	},
	randomUV(repository, photo, offset, width, height) {
		photo = repository[photo];
		if (photo.length / 4 - 1 >= offset) {
			return [photo[offset *= 4], photo[offset + 1], photo[offset + 2] - photo[offset], photo[offset + 3] - photo[offset + 1]];
		}
		let x = ShadyAppraiser.randomInt(0, width),
			y = ShadyAppraiser.randomInt(0, height);
		return [ShadyAppraiser.randomInt(width - x), ShadyAppraiser.randomInt(height - y), x, y];
	}
};

const BitmapFactory = {
	BACKED_FACES: [],
	REQUIRES_MODDERS: ["grass.png", "grass_top.png", "grass_carried.png", "grass_side.tga", "grass_side_snowed.tga",
		"netherrack.png", "end_stone.png", "birch.png", "foliage.png", "swamp_foliage.png", "swamp_grass.png",
		"evergreen.png", "sun.png", "moon_phases.png", "clouds.png", "map_background.png", "pack_icon.png"],

	upscale(bitmap) {
		bitmap = android.graphics.Bitmap.createBitmap(bitmap, 0, 0, bitmap.getWidth(), bitmap.getHeight());
		try {
			let scaled = android.graphics.Bitmap.createScaledBitmap(bitmap, Constants.ATLAS_MODIFIER, bitmap.getHeight() / bitmap.getWidth() * Constants.ATLAS_MODIFIER, false);
			try {
				return scaled.copy(android.graphics.Bitmap.Config.ARGB_8888, true);
			} finally {
				scaled.recycle();
			}
		} finally {
			bitmap.recycle();
		}
	},
	bake(photo, size) {
		let images = [];
		if (size <= 0) {
			return images;
		}
		let bytes = Workspace.unwrap(__dir__ + "assets/" + photo),
			source = android.graphics.BitmapFactory.decodeByteArray(bytes, 0, bytes.length);
		if (source == null) {
			log("Developers Everywhere: Malformed photo " + photo + ", it will be skipped...");
			return images;
		}
		try {
			let uvs = Workspace.FACES[photo],
				width = source.getWidth(),
				height = source.getHeight();
			for (let offset = 0; offset < size; offset++) {
				let uv = ShadyAppraiser.randomUV(Workspace.FACES, photo, offset, width, height),
					target = android.graphics.Bitmap.createBitmap(source, uv[0], uv[1], uv[2], uv[3]);
				try {
					let scaled = android.graphics.Bitmap.createScaledBitmap(target, Constants.ATLAS_MODIFIER, Constants.ATLAS_MODIFIER, false);
					if (uvs.length / 4 - 1 <= offset) {
						BitmapFactory.BACKED_FACES.push(scaled);
					}
					images.push(scaled);
				} finally {
					target.recycle();
				}
			}
			return images;
		} finally {
			source.recycle();
		}
	},
	redraw(content, input, output, textures) {
		let inputFile = new java.io.File(input, content);
		if (!inputFile.exists()) {
			return;
		}
		let resources = [];
		try {
			resources = Resources.getAllMatchingResourcesInDir(inputFile, "(.*/)*.+\\.(png|tga)$");
		} catch (e) {
			resources.push(inputFile.getPath());
		}
		if (resources.length == 0) {
			return;
		}
		let paint = new android.graphics.Paint();
		paint.setXfermode(new android.graphics.PorterDuffXfermode(android.graphics.PorterDuff.Mode.SRC_IN));
		let canvas = new android.graphics.Canvas();
		for (let resource = 0; resource < resources.length; resource++) {
			let relative = resources[resource].substring(input.length + content.length + 1);
			Workspace.appendProgressLabel("redrawing " + content + relative);
			try {
				relative = ("" + relative).replace(/^\/+|\/+$/g, "");
				let bitmap = (function() {
					if (relative.endsWith("tga")) {
						return Workspace.decodeTga(resources[resource]);
					}
					return android.graphics.BitmapFactory.decodeFile(resources[resource]);
				})();
				let outputFile = new java.io.File(output, relative.endsWith(".tga") ? relative.substring(0, relative.length - 4) + ".png" : relative);
				com.zhekasmirnov.innercore.utils.FileTools.assureFileDir(outputFile);
				let scaled = BitmapFactory.upscale(bitmap);
				bitmap.recycle();
				try {
					let repository = BitmapFactory.REQUIRES_MODDERS.indexOf(relative) != -1 ? BitmapFactory.BACKED_FACES : textures;
					canvas.setBitmap(scaled);
					let width = scaled.getWidth(), height = scaled.getHeight();
					for (let offset = 0, flipbook = width < height ? height / width : 1; offset < flipbook; offset++) {
						canvas.drawBitmap(repository[ShadyAppraiser.randomInt(repository.length - 1)], 0, width * offset, paint);
					}
					com.zhekasmirnov.innercore.utils.FileTools.writeBitmap(outputFile.getPath(), scaled);
				} finally {
					scaled.recycle();
				}
			} catch (e) {
				log("Developers Everywhere: " + e + " (" + relative + ")");
			}
		}
	}
};

(function() {
	let backgrounds = [];
	for (let offset = 0, count = ShadyAppraiser.randomInt(5, 8); offset < count; offset++) {
		let photo = ShadyAppraiser.randomPhoto(Workspace.PHOTOS);
		if (backgrounds.indexOf(photo) == -1) {
			backgrounds.push(photo);
		}
	}
	backgrounds = backgrounds.map(function(photo) {
		return new java.io.File(__dir__ + "assets", photo);
	});
	backgrounds = backgrounds.filter(function(photo) {
		return photo.isFile();
	});
	let graphicsOutput = new java.io.File(__packdir__ + ".cached_graphics");
	let graphicsBackup = new java.io.File(__packdir__ + ".cached_graphics.bak");
	if (graphicsOutput.exists() && !graphicsBackup.exists()) {
		com.zhekasmirnov.innercore.utils.FileTools.copy(graphicsOutput, graphicsBackup);
	}
	let charsetAscii = java.nio.charset.Charset.forName("US-ASCII");
	if (graphicsOutput.exists()) {
		graphicsOutput.delete();
	}
	let zipOutput = new java.io.FileOutputStream(graphicsOutput);
	try {
		zipOutput = new java.io.BufferedOutputStream(zipOutput);
		zipOutput = new java.util.zip.ZipOutputStream(zipOutput, charsetAscii);
		for (let offset = 0; offset < backgrounds.length; offset++) {
			let entry = new java.util.zip.ZipEntry("background@" + (offset + 1) + ".png");
			zipOutput.putNextEntry(entry);
			Workspace.appendProgressLabel("encoding " + offset + "/" + backgrounds.length + " background");
			let background = Workspace.unwrap(backgrounds[offset]);
			zipOutput.write(background, 0, background.length);
			zipOutput.closeEntry();
		}
		if (graphicsBackup.exists()) {
			let zipBackups = new java.util.zip.ZipFile(graphicsBackup.getPath(), charsetAscii);
			try {
				let zipEntries = zipBackups.entries();
				while (zipEntries.hasMoreElements()) {
					let assetEntry = zipEntries.nextElement();
					if (!assetEntry.getName().startsWith("background")) {
						zipOutput.putNextEntry(assetEntry);
						let assetStream = zipBackups.getInputStream(assetEntry),
							buffer = java.lang.reflect.Array.newInstance(java.lang.Byte.TYPE, 4096);
						for (let size; (size = assetStream.read(buffer, 0, 4096)) >= 0; ) {
							zipOutput.write(buffer, 0, size);
						}
						zipOutput.closeEntry();
					}
				}
			} finally {
				zipBackups.close();
			}
		}
	} finally {
		zipOutput.close();
	}
})();

Workspace.setProgressLabel("restoring resources");

(function() {
	let packGraphics = new java.io.FileInputStream(__packdir__ + ".cached_graphics");
	try {
		let repository = new com.zhekasmirnov.horizon.launcher.pack.PackGraphics(packGraphics),
			backgrounds = repository.getGroupWithBrightnessThreshold("background", .45);
		if (backgrounds != null) {
			let drawable = new com.zhekasmirnov.horizon.activity.main.AnimatedBitmapCollectionDrawable(backgrounds, 4500, 750);
			drawable.setAnimationParameters(.00105, 150, 75, false);
			Workspace.setBackground(drawable);
		}
	} finally {
		packGraphics.close();
	}
	let context = com.zhekasmirnov.horizon.HorizonApplication.getTopActivity();
	if (context != null) {
		let layout = context.findViewById(com.zheka.horizon.R.id.horizon_activity_recycler_view_layout);
		let packLeave = context.findViewById(com.zheka.horizon.R.id.main_menu_exit_pack);
		let packPlay = context.findViewById(com.zheka.horizon.R.id.main_menu_launch_button);
		if (packPlay != null && packLeave.getParent() != packPlay.getParent()) {
			packLeave = packLeave.getParent();
		}
		context.runOnUiThread(function() {
			if (layout != null) {
				let container = layout.getParent();
				if (container != null) {
					let slide = new android.transition.Slide(android.view.Gravity.RIGHT);
					slide.setDuration(1500);
					android.transition.TransitionManager.beginDelayedTransition(container, slide);
				}
				layout.setVisibility(android.view.View.GONE);
			}
			if (packLeave != null) {
				packLeave.setVisibility(android.view.View.GONE);
			}
			if (packPlay != null) {
				packPlay.setVisibility(android.view.View.GONE);
			}
		});
	}
})();

(function() {
	let allResourceDirectories = com.zhekasmirnov.mcpe161.InnerCore.getInstance().allResourceDirectories,
		outputDirectory = new java.io.File(__dir__ + "resources/"),
		offset = allResourceDirectories.indexOf(outputDirectory);
	if (offset != -1) {
		allResourceDirectories.remove(offset);
	}
	allResourceDirectories.add(0, outputDirectory);
	if (Constants.ATLAS_CLEAN) {
		com.zhekasmirnov.innercore.utils.FileTools.delete(__dir__ + "resources");
		com.zhekasmirnov.innercore.utils.FileTools.assureDir(__dir__ + "resources");
		new java.io.File(__dir__ + "resources/.nomedia").createNewFile();
	}
})();

const rebuildPackManifest = function(directory) {
	Workspace.setProgressLabel("rebuilding pack manifest");
	let modSprite = new java.io.File(__dir__ + "mod_icon.png");
	let packSprite = new java.io.File(directory + "/pack_icon.png");
	if (modSprite.exists() && !packSprite.exists()) {
		com.zhekasmirnov.innercore.utils.FileTools.copy(modSprite, packSprite);
	}
	let file = new java.io.File(directory + "/manifest.json"),
		json = com.zhekasmirnov.innercore.utils.FileTools.readFileText(file);
	try {
		json = new org.json.JSONObject(json).toString();
	} catch (e) {
	}
	try {
		json = JSON.parse(json);
	} catch (e) {
		log("Developers Everywhere: Malformed pack manifest.json, it will be skipped: " + e);
		return;
	}
	json.header || (json.header = {});
	json.header.name = "" + __mod__.getInfoProperty("name");
	json.header.description = "" + __mod__.getInfoProperty("description");
	json.modules || (json.modules = []);
	json.modules[0] || (json.modules[0] = {});
	json.modules[0].description = json.header.description;
	com.zhekasmirnov.innercore.utils.FileTools.writeFileText(file.getPath(), JSON.stringify(json));
};

const rebuildJsonResources = function(directory) {
	(function() {
		let milliseconds = Date.now();
		Workspace.setProgressLabel("rebuilding json resources");
		for (let offset = 0; offset < arguments.length; offset += 3) {
			let milliseconds = Date.now();
			Workspace.appendProgressLabel("encoding " + arguments[offset]);
			let file = new java.io.File(__packdir__ + "assets/resource_packs/vanilla/" + arguments[offset]),
				json = com.zhekasmirnov.innercore.utils.FileTools.readFileText(file);
			try {
				json = new org.json.JSONObject(json).toString();
			} catch (e) {
			}
			try {
				json = JSON.parse(json);
			} catch (e) {
				log("Developers Everywhere: Malformed json " + arguments[offset] + ", it will be skipped: " + e);
				continue;
			}
			try {
				arguments[offset + 2].call(json, file);
			} catch (e) {
				log("Developers Everywhere: Something unexpected happened when injecting buggy shitcode to " + arguments[offset] + ": " + e);
				continue;
			}
			let path = arguments[offset + 1] ? __dir__ + "resources/" : directory + "/";
			com.zhekasmirnov.innercore.utils.FileTools.assureDir(new java.io.File(path, arguments[offset]).getParent());
			com.zhekasmirnov.innercore.utils.FileTools.writeFileText(path + arguments[offset], JSON.stringify(json));
			log("Developers Everywhere: Encoding " + arguments[offset] + " done in " + (Date.now() - milliseconds) + "ms");
		}
		log("Developers Everywhere: Injected buggy shitcode in " + (Date.now() - milliseconds) + "ms");
	})("splashes.json", true, function(file) {
		for (let splash = 0; splash < this.splashes.length; splash++) {
			if (Math.random() < .1) {
				this.splashes[splash] = __name__ + "!";
			}
			if (Math.random() < .2) {
				this.splashes[splash] = this.splashes[splash].split("").reverse().join("");
			} else if (Math.random() < .1) {
				this.splashes[splash] = this.splashes[splash].split("").join();
				continue;
			}
			if (Math.random() < .1) {
				this.splashes[splash] = this.splashes[splash].split("").sort().join("");
			}
			if (Math.random() < .3) {
				this.splashes[splash] = this.splashes[splash].split("").map(function(entry) {
					return Math.random() < .5 ? entry.toUpperCase() : entry.toLowerCase();
				}).join("");
			}
			if (Math.random() < .2) {
				this.splashes[splash] = this.splashes[splash].split("").map(function(entry) {
					return entry.charCodeAt(0);
				}).join("");
			}
		}
	}, "biomes_client.json", false, function(file) {
		for (let biome in this.biomes) {
			ShadyAppraiser.shuffleHexes(this.biomes[biome], "water_surface_color", "water_fog_color", "fog_color");
		}
	}, "sounds/sound_definitions.json", false, function(file) {
		let definitions = [];
		for (let category in this) {
			let sounds = this[category].sounds;
			definitions = definitions.concat(sounds);
		}
		for (let category in this) {
			this[category].sounds = this[category].sounds.map(function(entry) {
				let offset = ShadyAppraiser.randomInt(definitions.length),
					sound = definitions[offset];
				if (Math.random() < .75) {
					typeof sound != "object" && (sound = { name: sound });
					sound.pitch = ShadyAppraiser.randomInt(20) / 10;
					if (Math.random() < .6) {
						sound.volume = ShadyAppraiser.randomInt(100) / 10;
					}
				}
				definitions.splice(offset, 1);
				return sound;
			});
		}
	}, "textures/flipbook_textures.json", false, function(file) {
		for (let texture = 0; texture < this.length; texture++) {
			if (this[texture].ticks_per_frame != null) {
				this[texture].ticks_per_frame = ShadyAppraiser.randomInt(1, 8) * this[texture].ticks_per_frame;
			}
		}
	}, "textures/terrain_texture.json", false, function(file) {
		for (let texture in this.texture_data) {
			let block = this.texture_data[texture];
			if (Array.isArray(block.textures)) {
				for (let side = 0; side < block.textures.length; side++) {
					ShadyAppraiser.shuffleHexes(block.textures[side], "overlay_color", "tint_color");
				}
			} else if (typeof block.textures == "object") {
				ShadyAppraiser.shuffleHexes(block.textures, "overlay_color", "tint_color");
			}
		}
	}, "ui/_global_variables.json", true, function(file) {
		for (let color in this) {
			this[color] = [ShadyAppraiser.randomInt(100) / 100, ShadyAppraiser.randomInt(100) / 100, ShadyAppraiser.randomInt(100) / 100];
		}
	});
};

const redrawAssetsEntirely = function(directory) {
	let milliseconds = Date.now();
		textures = [];
	Workspace.setProgressLabel("redrawing assets");
	try {
		let photos = com.zhekasmirnov.innercore.utils.FileTools.listDirectory(__dir__ + "assets");
		photos = photos.filter(function(name) {
			return new java.io.File(__dir__ + "assets", name).isFile();
		});
		for (let photo = 0; photo < photos.length; photo++) {
			let size = Workspace.FACES[photos[photo]] ? Workspace.FACES[photos[photo]].length / 4 : 0;
			if (size > 0) {
				Workspace.appendProgressLabel("decoding " + (photo + 1) + "/" + photos.length + " sprites");
				let encounter = Math.sqrt(Math.sqrt(ShadyAppraiser.randomInt(0, Constants.RANDOM_ENCOUNTER)));
				textures = textures.concat(BitmapFactory.bake(photos[photo], size * encounter));
			}
		}
		if (textures.length == 0) {
			return;
		}
		(function() {
			let resources = Resources.getAllResourceDirectoriesPaths();
			let subpacks = com.zhekasmirnov.innercore.utils.FileTools.listDirectory(__packdir__ + "assets/resource_packs");
			subpacks = subpacks.filter(function(subpack) {
				return /^vanilla_\d/.test(subpack) || subpack == "vanilla" || subpack == "chemistry" || subpack == "education";
			});
			subpacks = subpacks.map(function(subpack) {
				return __packdir__ + "assets/resource_packs/" + subpack;
			});
			subpacks.push(__packdir__ + "assets/textures");
			for (let subfolder = 0; subfolder < arguments.length; subfolder++) {
				let milliseconds = Date.now();
				if (resources.length > 0) {
					let resourceDirectory = __dir__ + "resources/" + arguments[subfolder];
					for (let resource = 0; resource < resources.length; resource++) {
						if (__dir__ + "resources" != resources[resource]) {
							BitmapFactory.redraw(arguments[subfolder], resources[resource], resourceDirectory, textures);
						}
					}
				}
				if (subpacks.length > 0) {
					let resourceDirectory = directory + "/" + arguments[subfolder];
					for (let subpack = 0; subpack < subpacks.length; subpack++) {
						BitmapFactory.redraw(arguments[subfolder], subpacks[subpack], resourceDirectory, textures);
					}
				}
				log("Developers Everywhere: Redrawn " + arguments[subfolder] + " done in " + (Date.now() - milliseconds) + "ms");
			}
		})("textures/blocks", "terrain-atlas", "textures/items", "items-opaque", "textures/models/armor",
			"textures/map", "textures/misc", "textures/particle", "particle-atlas", "textures/environment",
			"textures/colormap", "textures/entity/bed", "textures/entity/bell", "textures/entity/boat",
			"textures/entity/chest", "textures/entity/pistonarm", "textures/entity/armor_stand.png",
			"textures/entity/beacon_beam.png", "textures/entity/end_portal.png", "textures/entity/sign.png",
			"textures/entity/sign_acacia.png", "textures/entity/sign_birch.png", "textures/entity/sign_darkoak.png",
			"textures/entity/sign_jungle.png", "textures/entity/sign_spruce.png", "textures/entity/trident.png",
			"textures/entity/trident_riptide.png", "textures/flame_atlas.png", "textures/blocks/huge_fungus");
	} finally {
		for (let offset = 0; offset < textures.length; offset++) {
			textures[offset].recycle();
		}
	}
	while (BitmapFactory.BACKED_FACES.length > 0) {
		BitmapFactory.BACKED_FACES.pop();
	}
	log("Developers Everywhere: Redrawn entirely in " + (Date.now() - milliseconds) + "ms");
};

Callback.addCallback("AddRuntimePacks", function() {
	let directory = Resources.addRuntimePack("resource", __name__);
	rebuildPackManifest(directory);
	rebuildJsonResources(directory);
	redrawAssetsEntirely(directory);
	Workspace.setProgressLabel("build");
});

Workspace.setProgressLabel("build");
